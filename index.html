<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthCare AI Assistant - Advanced Health Companion</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        #root {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            height: 95vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .header-btn:hover {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
        }

        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .health-stats {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .stat-value {
            color: #212529;
            font-weight: 600;
            font-size: 1.1em;
        }

        .reminder-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .reminder-card:hover {
            transform: translateX(5px);
        }

        .reminder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .reminder-name {
            color: #212529;
            font-weight: 600;
            font-size: 1em;
        }

        .reminder-time {
            color: #667eea;
            font-weight: 700;
            font-size: 0.95em;
        }

        .reminder-details {
            color: #6c757d;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .delete-btn {
            margin-top: 10px;
            padding: 6px 14px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .add-reminder-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s;
        }

        .add-reminder-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .health-tip-card {
            background: linear-gradient(135deg, #e0f7fa 0%, #f3e5f5 100%);
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .health-tip-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .health-tip-card p {
            color: #424242;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .context-banner {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 12px 20px;
            border-bottom: 2px solid #fbbf24;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #92400e;
        }

        .context-banner strong {
            color: #78350f;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: linear-gradient(180deg, #fafafa 0%, #ffffff 100%);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .message-content {
            max-width: 75%;
            padding: 16px 20px;
            border-radius: 16px;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .message.bot .message-content {
            background: #f1f3f5;
            border-bottom-left-radius: 4px;
            color: #212529;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-bottom-right-radius: 4px;
            color: white;
        }

        .message-content strong {
            display: block;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .message-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 5px 0;
        }

        .symptom-badge {
            display: inline-block;
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            margin: 4px;
            font-weight: 600;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: #f1f3f5;
            border-radius: 16px;
            width: fit-content;
            border-bottom-left-radius: 4px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            height: 10px;
            width: 10px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { 
                transform: translateY(0);
                opacity: 0.7;
            }
            30% { 
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .quick-actions {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 2px solid #e9ecef;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: all 0.3s;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 35px;
            max-width: 550px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1em;
            outline: none;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            width: 100%;
            font-size: 1.05em;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            width: 100%;
            font-size: 1.05em;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                border-radius: 0;
            }

            .sidebar {
                display: none;
            }

            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Main App Component
        function HealthCareApp() {
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [reminders, setReminders] = useState([]);
            const [userProfile, setUserProfile] = useState({});
            const [showReminderModal, setShowReminderModal] = useState(false);
            const [showProfileModal, setShowProfileModal] = useState(false);
            const [conversationContext, setConversationContext] = useState({
                symptoms: [],
                concerns: [],
                medications: [],
                lastTopic: null
            });
            const messagesEndRef = useRef(null);
            const chatInputRef = useRef(null);

            // Storage helper
            const storage = {
                get: async (key) => {
                    try {
                        const result = await window.storage.get(key, false);
                        return result ? JSON.parse(result.value) : null;
                    } catch (e) {
                        return null;
                    }
                },
                set: async (key, value) => {
                    try {
                        await window.storage.set(key, JSON.stringify(value), false);
                    } catch (e) {
                        console.error('Storage error:', e);
                    }
                }
            };

            // Load data on mount
            useEffect(() => {
                loadData();
                addBotMessage(
                    "Hello! I'm your **Virtual Health Assistant & Triage Specialist**. ðŸ‘‹\n\n" +
                    "I provide evidence-based health guidance and help you understand the urgency of your symptoms.\n\n" +
                    "**I can help you with:**\n" +
                    "â€¢ ðŸ©º Symptom triage & urgency assessment\n" +
                    "â€¢ ðŸ½ï¸ Personalised diet & nutrition plans\n" +
                    "â€¢ ðŸ’ª Exercise recommendations for your condition\n" +
                    "â€¢ ðŸ’Š Medicine reminders & chronic condition support\n" +
                    "â€¢ ðŸŒ¿ Home remedies & preventive health tips\n\n" +
                    "ðŸš¨ **Emergency?** If you have chest pain, difficulty breathing, sudden numbness, or any life-threatening symptom â€” tell me immediately and I will give you emergency contact numbers.\n\n" +
                    "âš•ï¸ **Disclaimer:** I am not a doctor and cannot diagnose or prescribe. For serious symptoms, always consult a qualified healthcare professional.\n\n" +
                    "To get started, could you share your **age** and any **existing health conditions** (e.g., diabetes, hypertension)? This helps me give you the most relevant guidance."
                );
            }, []);

            // Auto-scroll to bottom
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages, isTyping]);

            // Check reminders
            useEffect(() => {
                const interval = setInterval(checkReminders, 60000);
                checkReminders();
                return () => clearInterval(interval);
            }, [reminders]);

            async function loadData() {
                const loadedReminders = await storage.get('health-reminders');
                const loadedProfile = await storage.get('health-profile');
                
                if (loadedReminders) setReminders(loadedReminders);
                if (loadedProfile) setUserProfile(loadedProfile);
            }

            function addBotMessage(text) {
                setMessages(prev => [...prev, { type: 'bot', text, timestamp: new Date() }]);
            }

            function addUserMessage(text) {
                setMessages(prev => [...prev, { type: 'user', text, timestamp: new Date() }]);
            }

            async function sendMessage() {
                if (!inputValue.trim() || isTyping) return;

                const userMessage = inputValue.trim();
                addUserMessage(userMessage);
                setInputValue('');

                // ðŸš¨ EMERGENCY TRIAGE â€” Red Flag check (highest priority)
                if (checkEmergency(userMessage)) {
                    addBotMessage(
                        `ðŸš¨ **EMERGENCY ALERT â€” CALL FOR HELP IMMEDIATELY** ðŸš¨\n\n` +
                        `Based on what you've described, this may be a **life-threatening emergency**.\n\n` +
                        `**ðŸ“ž Call Emergency Services RIGHT NOW:**\n` +
                        `â€¢ ðŸ‡®ðŸ‡³ India: **102** (Ambulance) / **108** (Emergency)\n` +
                        `â€¢ ðŸ‡ºðŸ‡¸ USA / Canada: **911**\n` +
                        `â€¢ ðŸ‡¬ðŸ‡§ UK: **999**\n` +
                        `â€¢ ðŸŒ International Emergency: **112**\n\n` +
                        `**âš ï¸ Do NOT wait. Do NOT drive yourself. Ask someone nearby to help or call now.**\n\n` +
                        `_This bot cannot provide emergency care. Please contact emergency services immediately._`
                    );
                    return;
                }

                setIsTyping(true);

                // Analyze message for context
                analyzeUserMessage(userMessage);

                // Get AI response
                await getAIResponse(userMessage);
                setIsTyping(false);
            }

            // RED FLAG emergency keywords â€” triggers immediate escalation
            const EMERGENCY_KEYWORDS = [
                'chest pain', 'chest tightness', 'heart attack', 'can\'t breathe', 'cannot breathe',
                'difficulty breathing', 'shortness of breath', 'trouble breathing',
                'sudden numbness', 'stroke', 'unconscious', 'not breathing', 'stopped breathing',
                'fainting', 'fainted', 'blacked out', 'severe bleeding', 'coughing blood',
                'vomiting blood', 'blood in stool', 'suicidal', 'overdose', 'poisoning',
                'severe allergic', 'anaphylaxis', 'throat closing', 'can\'t swallow',
                'unresponsive', 'seizure', 'convulsion', 'paralysis'
            ];

            function checkEmergency(message) {
                const lower = message.toLowerCase();
                return EMERGENCY_KEYWORDS.some(kw => lower.includes(kw));
            }

            function analyzeUserMessage(message) {
                const lowerMessage = message.toLowerCase();
                
                // Extract symptoms
                const symptomKeywords = ['fever', 'feverish', 'headache', 'cough', 'cold', 'pain', 'dizzy', 'nausea', 'tired', 'fatigue', 'sore', 'ache', 'sick'];
                const detectedSymptoms = symptomKeywords.filter(s => lowerMessage.includes(s));
                
                if (detectedSymptoms.length > 0) {
                    setConversationContext(prev => ({
                        ...prev,
                        symptoms: [...new Set([...prev.symptoms, ...detectedSymptoms])]
                    }));
                }

                // Detect topic
                if (lowerMessage.includes('diet') || lowerMessage.includes('food') || lowerMessage.includes('eat')) {
                    setConversationContext(prev => ({ ...prev, lastTopic: 'nutrition' }));
                } else if (lowerMessage.includes('exercise') || lowerMessage.includes('workout')) {
                    setConversationContext(prev => ({ ...prev, lastTopic: 'exercise' }));
                } else if (detectedSymptoms.length > 0) {
                    setConversationContext(prev => ({ ...prev, lastTopic: 'symptoms' }));
                }
            }

            async function getAIResponse(userMessage) {
                try {
                    // â”€â”€ ROCAS Framework System Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    let systemPrompt = `ROLE:
You are a Certified Virtual Health Assistant and Triage Specialist built for HealthCare AI Assistant. You provide evidence-based health information, explain medical terms in plain language, and help users determine the urgency of their symptoms.
CRUCIAL CONSTRAINT: You are NOT a doctor. You cannot provide a final diagnosis or prescribe/recommend specific dosages for Schedule H or prescription drugs. Always state this disclaimer clearly.

OBJECTIVE:
Provide instant, structured health guidance 24/7. Help users track chronic conditions (diabetes, blood pressure, thyroid, etc.), bridge the gap between "searching online" and "visiting a clinic", and always escalate appropriately when symptoms are serious.

CONTEXT:
The user may be feeling unwell, anxious, or seeking clarity about a lab report or medication side effect. They are using a chat interface and need responses that are easy to read even when they are in pain or stressed. Keep responses concise and structured.

ACTION â€” Follow this 4-step triage flow:
1. VITALS INTAKE: If the user has not shared age, gender, or pre-existing conditions yet, ask for them early. Example: "To give you the best guidance, may I know your age and whether you have any existing conditions like diabetes or hypertension?"
2. SYMPTOM TRIAGE: Classify urgency as one of:
   - ðŸš¨ EMERGENCY: Chest pain, difficulty breathing, sudden numbness, loss of consciousness, severe allergic reaction â†’ Direct to emergency services (102/108 India, 911 USA, 999 UK, 112 international). Stop analysis and provide numbers immediately.
   - âš ï¸ URGENT: High fever (>103Â°F/39.4Â°C) lasting >2 days, severe vomiting/diarrhea, worsening pain â†’ Recommend same-day clinic visit.
   - â„¹ï¸ NON-URGENT: Mild symptoms, general wellness questions â†’ Provide structured home care guidance.
3. INFORMATION: Explain symptoms using the most common, likely causes first (avoid "WebMD syndrome" â€” do NOT suggest rare or alarming diagnoses like cancer for everyday symptoms). Reference best practices aligned with trusted sources (NHS, Mayo Clinic, WHO).
4. NEXT STEPS: Always close with a numbered "Next Steps" list and a standard disclaimer.

CONSTRAINT â€” SAFETY RULES (Never break these):
- If ANY life-threatening keyword appears (chest pain, can't breathe, stroke, fainting, seizure, severe bleeding, suicidal, overdose) â†’ STOP everything and output emergency numbers ONLY.
- Never suggest specific dosages for prescription drugs.
- Never diagnose a specific disease â€” describe what symptoms may indicate and refer to a doctor.
- Always ask at least one clarifying question before giving detailed advice: "How long has this been happening?" or "Is this getting better or worse?"
- Every response with medical advice MUST end with: âš•ï¸ Disclaimer: This information is for general guidance only and does not replace professional medical advice. Please consult a qualified doctor for diagnosis and treatment.

FORMATTING RULES:
- Use emoji indicators: ðŸš¨ for emergencies, âš ï¸ for warnings, âœ… for safe actions, â„¹ï¸ for information
- Use numbered lists for "Next Steps"
- Use bullet points for symptoms
- Bold all important warnings
- Keep responses under 200 words when possible (for mobile readability)
- Be empathetic and calm: "I understand this is concerning â€” let's look at this together."

DATA PRIVACY NOTE:
Never ask for or store sensitive personal identifiers (Aadhaar, SSN, insurance numbers). Health data shared in this chat is for guidance only.`;


                    // Append dynamic user context
                    if (userProfile.age) {
                        systemPrompt += `\n\nUSER PROFILE (collected earlier):
- Age: ${userProfile.age}
- Gender: ${userProfile.gender || 'Not specified'}
- Pre-existing conditions: ${userProfile.conditions || 'None mentioned'}
- Allergies: ${userProfile.allergies || 'None mentioned'}
Use this profile to personalise triage and advice. An elderly user (65+) or a diabetic patient requires extra caution.`;
                    }

                    if (conversationContext.symptoms.length > 0) {
                        systemPrompt += `\n\nACTIVE SYMPTOMS IN THIS SESSION: ${conversationContext.symptoms.join(', ')}
Follow up on these symptoms. Ask clarifying questions (duration, severity, progression) before giving detailed advice.`;
                    }

                    if (conversationContext.lastTopic) {
                        systemPrompt += `\n\nCURRENT SESSION TOPIC: ${conversationContext.lastTopic}`;
                    }

                    systemPrompt += `\n\nCONVERSATION CONTINUITY: This is an ongoing conversation. Reference what the user has said before. Build on context naturally.`;

                    // Build conversation history
                    const conversationHistory = messages.slice(-8).map(msg => ({
                        role: msg.type === 'user' ? 'user' : 'assistant',
                        content: msg.text
                    }));

                    conversationHistory.push({
                        role: 'user',
                        content: userMessage
                    });

                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 2000,
                            system: systemPrompt,
                            messages: conversationHistory
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.content && data.content[0]) {
                        const aiResponse = data.content[0].text;
                        addBotMessage(aiResponse);
                    } else {
                        throw new Error('Invalid AI response');
                    }
                } catch (error) {
                    console.error('AI Error:', error);
                    // Provide helpful fallback response based on the question
                    provideFallbackResponse(userMessage);
                }
            }

            function provideFallbackResponse(userMessage) {
                const lowerMsg = userMessage.toLowerCase();
                
                // Fever response
                if (lowerMsg.includes('fever') || lowerMsg.includes('feverish')) {
                    addBotMessage(`I understand you're feeling feverish. Let me help you with some guidance:

**Immediate Care for Fever:**

**What to Do:**
â€¢ Rest as much as possible - your body needs energy to fight infection
â€¢ Stay hydrated - drink water, clear broths, herbal teas (8-10 glasses/day)
â€¢ Monitor temperature every 4 hours
â€¢ Take acetaminophen (Tylenol) or ibuprofen (Advil) as directed on package

**Home Remedies:**
â€¢ Cool compress on forehead and neck
â€¢ Lukewarm bath (not cold) to reduce temperature
â€¢ Wear light, breathable clothing
â€¢ Keep room temperature comfortable (not too warm)

**Foods to Eat:**
â€¢ Chicken soup or vegetable broth
â€¢ Bananas (easy to digest, rich in potassium)
â€¢ Rice porridge (khichdi)
â€¢ Toast or crackers
â€¢ Yogurt (probiotics boost immunity)
â€¢ Citrus fruits (vitamin C)
â€¢ Coconut water (hydration + electrolytes)

**Foods to Avoid:**
â€¢ Spicy or fried foods
â€¢ Heavy meals
â€¢ Caffeine and alcohol
â€¢ Sugary drinks

**Herbal Remedies:**
â€¢ Tulsi (holy basil) tea
â€¢ Ginger tea with honey
â€¢ Turmeric milk (haldi doodh)

**When to See a Doctor:**
ðŸš¨ Fever above 103Â°F (39.4Â°C)
ðŸš¨ Fever lasting more than 3 days
ðŸš¨ Severe headache or stiff neck
ðŸš¨ Difficulty breathing
ðŸš¨ Persistent vomiting
ðŸš¨ Confusion or unusual behavior

**For elderly patients (65+):** Be extra cautious and consult a doctor if fever persists beyond 24 hours.

Would you like specific meal plans or more information about managing your symptoms?`);
                }
                // Diabetes diet
                else if (lowerMsg.includes('diabetes') && (lowerMsg.includes('diet') || lowerMsg.includes('food') || lowerMsg.includes('eat'))) {
                    addBotMessage(`Here's a comprehensive **Diabetes-Friendly Diet Plan**:

**Daily Meal Plan:**

ðŸŒ… **BREAKFAST (8:00 AM)**
Option 1: Indian
â€¢ 2 multigrain rotis
â€¢ 1 bowl vegetable daliya (oats porridge)
â€¢ 1 boiled egg or paneer bhurji
â€¢ 1/2 cup buttermilk

Option 2: Western
â€¢ 2 scrambled eggs
â€¢ 1 slice whole wheat toast
â€¢ 1/2 cup berries
â€¢ Unsweetened almond milk

**Mid-Morning Snack (11:00 AM)**
â€¢ 1 small apple with 10 almonds
â€¢ OR green tea + 2-3 whole wheat crackers

ðŸŒž **LUNCH (1:00 PM)**
â€¢ 2 bajra/jowar rotis
â€¢ 1 bowl dal (moong/masoor)
â€¢ 1 bowl mixed vegetables (palak, bhindi, beans)
â€¢ Cucumber-tomato salad
â€¢ 1 bowl curd

**Evening Snack (4:00 PM)**
â€¢ Roasted chana (chickpeas)
â€¢ OR vegetable soup
â€¢ Green/herbal tea

ðŸŒ™ **DINNER (7:30 PM)**
â€¢ 1.5 rotis or 1/2 cup brown rice
â€¢ Grilled fish/chicken or rajma/chole
â€¢ 1 bowl green vegetable
â€¢ Clear soup or raita

**KEY PRINCIPLES:**

âœ… **Foods to Include:**
â€¢ Whole grains (brown rice, oats, quinoa)
â€¢ Lean proteins (fish, chicken, eggs, dal, paneer)
â€¢ Non-starchy vegetables (spinach, broccoli, peppers)
â€¢ Healthy fats (nuts, seeds, olive oil)
â€¢ Low-glycemic fruits (berries, apple, guava)

âŒ **Foods to Avoid:**
â€¢ White rice, white bread, maida
â€¢ Sugary drinks and desserts
â€¢ Fried foods
â€¢ Processed snacks
â€¢ Fruit juices (even fresh)

**Important Tips:**
1. Eat at the same time every day
2. Portion control is crucial
3. Never skip meals
4. Check blood sugar 2 hours after meals
5. Stay hydrated (8-10 glasses water)
6. Include fiber in every meal (minimum 25g/day)

**Diabetes Superfoods:**
â€¢ Bitter gourd (karela)
â€¢ Fenugreek seeds (methi)
â€¢ Cinnamon
â€¢ Amla (Indian gooseberry)
â€¢ Jamun (black plum)

Would you like specific recipes or a weekly meal plan?`);
                }
                // Senior exercise
                else if ((lowerMsg.includes('exercise') || lowerMsg.includes('workout')) && (lowerMsg.includes('senior') || lowerMsg.includes('elderly') || lowerMsg.includes('old'))) {
                    addBotMessage(`Here's a safe and effective **Exercise Plan for Seniors**:

**ðŸƒ Daily Exercise Routine (30-45 minutes)**

**WARM-UP (5 minutes):**
â€¢ Gentle neck rotations
â€¢ Shoulder rolls
â€¢ Ankle circles
â€¢ March in place slowly

**CARDIOVASCULAR (15-20 minutes):**
Choose one:
â€¢ Brisk walking (most recommended)
â€¢ Swimming or water aerobics
â€¢ Stationary cycling
â€¢ Dancing to music

**STRENGTH TRAINING (10-15 minutes, 3x per week):**
â€¢ Chair squats (10 reps)
â€¢ Wall push-ups (8-10 reps)
â€¢ Bicep curls with light weights (10 reps)
â€¢ Leg raises while holding chair (10 each leg)

**BALANCE EXERCISES (5-10 minutes):**
â€¢ Stand on one foot (hold chair for support)
â€¢ Heel-to-toe walk
â€¢ Tai Chi movements
â€¢ Standing hip circles

**FLEXIBILITY (5-10 minutes):**
â€¢ Seated toe touches
â€¢ Neck and shoulder stretches
â€¢ Hamstring stretches
â€¢ Gentle yoga poses

**SAFETY TIPS:**
âš ï¸ Always consult doctor before starting
âš ï¸ Start slowly and increase gradually
âš ï¸ Stay hydrated
âš ï¸ Wear proper footwear
âš ï¸ Exercise with a buddy when possible
âš ï¸ Stop if you feel dizzy, pain, or short of breath

**BEST TIME TO EXERCISE:**
â€¢ Morning (7-9 AM) or Evening (5-7 PM)
â€¢ Avoid exercising right after meals
â€¢ Never exercise during extreme heat

**Weekly Schedule:**
â€¢ Monday: Walking + Stretching
â€¢ Tuesday: Strength Training
â€¢ Wednesday: Walking + Balance
â€¢ Thursday: Rest or light yoga
â€¢ Friday: Strength Training
â€¢ Saturday: Walking + Swimming
â€¢ Sunday: Gentle stretching or rest

**Benefits for Seniors:**
âœ… Improves heart health
âœ… Strengthens bones (prevents osteoporosis)
âœ… Enhances balance (reduces fall risk)
âœ… Boosts mood and mental health
âœ… Better sleep quality
âœ… Manages chronic conditions (diabetes, BP)

Would you like specific exercises for any health condition?`);
                }
                // Sleep improvement
                else if (lowerMsg.includes('sleep') || lowerMsg.includes('insomnia')) {
                    addBotMessage(`Here's a complete guide to **Improve Your Sleep Quality**:

**ðŸŒ™ Bedtime Routine (Start 1 hour before sleep):**

**9:00 PM - Wind Down:**
â€¢ Dim the lights
â€¢ Turn off TV and phones
â€¢ Light reading or gentle music
â€¢ Avoid work emails

**9:30 PM - Relaxation:**
â€¢ Warm bath or shower
â€¢ Gentle stretching or yoga
â€¢ Deep breathing exercises
â€¢ Meditation (10 minutes)

**10:00 PM - Sleep Time:**
â€¢ Dark, cool room (65-68Â°F)
â€¢ Comfortable mattress and pillow
â€¢ White noise if needed

**Sleep-Promoting Foods:**

**Evening Snack (8:00 PM):**
â€¢ Warm milk with turmeric
â€¢ Banana with almond butter
â€¢ Chamomile or lavender tea
â€¢ Small bowl of oatmeal
â€¢ Handful of walnuts

**Foods to Avoid (after 6 PM):**
âŒ Caffeine (coffee, tea, chocolate)
âŒ Alcohol
âŒ Heavy or spicy meals
âŒ Sugary snacks
âŒ Large amounts of water (to avoid bathroom trips)

**Lifestyle Changes:**

**During the Day:**
â€¢ Wake up at same time daily (even weekends)
â€¢ Get sunlight exposure in morning
â€¢ Exercise (but not close to bedtime)
â€¢ Limit daytime naps to 20 minutes

**Sleep Environment:**
â€¢ Blackout curtains or eye mask
â€¢ Earplugs or white noise machine
â€¢ Cool temperature (18-20Â°C)
â€¢ Comfortable bedding
â€¢ Remove electronics

**Natural Sleep Remedies:**

â€¢ **Melatonin-rich foods:** Cherries, tomatoes, walnuts
â€¢ **Magnesium:** Spinach, almonds, dark chocolate
â€¢ **Herbal teas:** Chamomile, valerian root, passionflower
â€¢ **Essential oils:** Lavender (on pillow or diffuser)
â€¢ **Ashwagandha:** Ancient Ayurvedic herb

**Breathing Exercise for Sleep (4-7-8 Technique):**
1. Inhale through nose for 4 counts
2. Hold breath for 7 counts
3. Exhale through mouth for 8 counts
4. Repeat 4 times

**When to See a Doctor:**
ðŸš¨ Insomnia lasting more than 3 weeks
ðŸš¨ Loud snoring or breathing pauses (sleep apnea)
ðŸš¨ Extreme daytime fatigue
ðŸš¨ Restless legs or unusual movements

**Sleep Hygiene Checklist:**
âœ… Same sleep/wake time
âœ… Exercise daily
âœ… Limit caffeine after 2 PM
âœ… Dark, quiet, cool room
âœ… No screens 1 hour before bed
âœ… Relaxation routine
âœ… Comfortable bedding

Try these for 2 weeks and track your improvement. Would you like specific meditation techniques or sleep tracking tips?`);
                }
                // Stress management
                else if (lowerMsg.includes('stress') || lowerMsg.includes('anxiety') || lowerMsg.includes('tension')) {
                    addBotMessage(`Here's a comprehensive **Stress Management Guide**:

**ðŸ§˜ Immediate Stress Relief (Use anytime):**

**Deep Breathing (2 minutes):**
â€¢ Sit comfortably
â€¢ Breathe in slowly for 4 counts
â€¢ Hold for 4 counts
â€¢ Breathe out for 6 counts
â€¢ Repeat 10 times

**Quick Relaxation Techniques:**
â€¢ Progressive muscle relaxation
â€¢ 5-minute walk
â€¢ Listen to calming music
â€¢ Splash cold water on face
â€¢ Call a friend

**Daily Stress Management Routine:**

**Morning (7:00 AM):**
â€¢ 10 minutes meditation
â€¢ Gratitude journaling (write 3 things)
â€¢ Healthy breakfast
â€¢ Light exercise or yoga

**Throughout Day:**
â€¢ Take regular breaks (every 90 minutes)
â€¢ Stay hydrated
â€¢ Healthy snacks
â€¢ Brief walks

**Evening (7:00 PM):**
â€¢ Gentle exercise (walk, swim, yoga)
â€¢ Hobby or creative activity
â€¢ Quality time with family
â€¢ Avoid work emails

**Night (9:00 PM):**
â€¢ Relaxing bath
â€¢ Reading
â€¢ Gentle stretching
â€¢ Prepare for tomorrow

**Stress-Busting Foods:**

âœ… **Include:**
â€¢ Dark chocolate (in moderation)
â€¢ Green tea (L-theanine reduces stress)
â€¢ Berries (antioxidants)
â€¢ Nuts (magnesium)
â€¢ Yogurt (probiotics for gut-brain health)
â€¢ Salmon (omega-3)
â€¢ Oranges (vitamin C)

âŒ **Avoid:**
â€¢ Excess caffeine
â€¢ Alcohol
â€¢ Sugary foods
â€¢ Processed foods
â€¢ High-sodium foods

**Exercise for Stress Relief:**

**Best Activities:**
â€¢ Yoga (especially restorative)
â€¢ Walking in nature
â€¢ Swimming
â€¢ Dancing
â€¢ Tai Chi
â€¢ Cycling

**Recommended:** 30 minutes, 5 days/week

**Mental Wellness Practices:**

**Meditation (10-20 minutes daily):**
â€¢ Guided meditation apps
â€¢ Mindfulness practice
â€¢ Body scan meditation
â€¢ Loving-kindness meditation

**Journaling:**
â€¢ Write worries before bed
â€¢ Express emotions freely
â€¢ Problem-solve on paper
â€¢ Track mood patterns

**Social Connection:**
â€¢ Regular calls with loved ones
â€¢ Join support groups
â€¢ Volunteer work
â€¢ Hobby clubs

**Herbal Remedies for Stress:**

â€¢ **Ashwagandha:** Adaptogen, reduces cortisol
â€¢ **Brahmi:** Enhances mental clarity
â€¢ **Chamomile tea:** Calming effect
â€¢ **Tulsi (Holy Basil):** Stress reliever
â€¢ **Lavender:** Aromatherapy

**When to Seek Professional Help:**
ðŸš¨ Stress affecting daily functioning
ðŸš¨ Persistent anxiety or panic attacks
ðŸš¨ Sleep problems for weeks
ðŸš¨ Physical symptoms (chest pain, headaches)
ðŸš¨ Thoughts of self-harm

**Quick Stress-Relief Checklist:**
âœ… Deep breathing daily
âœ… Regular exercise
âœ… Healthy sleep routine
âœ… Social connections
âœ… Hobby or creative outlet
âœ… Limit news/social media
âœ… Time in nature
âœ… Professional help if needed

Would you like specific meditation techniques or yoga poses for stress relief?`);
                }
                // General health query
                else {
                    addBotMessage(`Thank you for your question! I'm here to help with your health concerns.

To provide you with the most accurate and helpful advice, could you please tell me more about:

**What I can help you with:**

ðŸ¥ **Symptoms & Conditions:**
â€¢ Fever, cold, cough management
â€¢ Headaches and body pain
â€¢ Digestive issues
â€¢ Sleep problems
â€¢ General health concerns

ðŸ½ï¸ **Diet & Nutrition:**
â€¢ Diabetes-friendly meal plans
â€¢ Weight loss/gain diets
â€¢ Heart-healthy eating
â€¢ Diet for specific conditions
â€¢ Meal planning and recipes

ðŸ’Š **Health Management:**
â€¢ Medicine reminders
â€¢ Chronic condition management
â€¢ Preventive health tips
â€¢ Lifestyle modifications

ðŸ’ª **Exercise & Fitness:**
â€¢ Senior-friendly exercises
â€¢ Yoga and stretching
â€¢ Walking programs
â€¢ Strength training

ðŸŒ¿ **Home Remedies:**
â€¢ Natural treatments
â€¢ Herbal remedies
â€¢ Traditional medicine (Ayurveda)

**Please share:**
1. What specific health concern do you have?
2. Any symptoms you're experiencing?
3. Your age (helps me personalize advice)
4. Any existing health conditions?

I'm here to provide detailed, practical advice including remedies, diet plans, and lifestyle recommendations!`);
                }
            }

            function handleKeyPress(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            }

            function quickAsk(question) {
                setInputValue(question);
                chatInputRef.current?.focus();
            }

            function checkReminders() {
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                reminders.forEach(reminder => {
                    if (reminder.time === currentTime && reminder.active) {
                        // Check if already notified in the last minute
                        const lastNotified = localStorage.getItem(`notified_${reminder.id}`);
                        const oneMinuteAgo = Date.now() - 60000;
                        
                        if (!lastNotified || parseInt(lastNotified) < oneMinuteAgo) {
                            showReminderNotification(reminder);
                            addBotMessage(`â° **MEDICINE REMINDER - ALARM!**\n\nðŸ”” Time to take your medicine:\nâ€¢ **${reminder.name}** - ${reminder.dosage}\n${reminder.notes ? `\nNote: ${reminder.notes}` : ''}\n\nâš•ï¸ Please take your medicine now and mark it as taken.\n\nHave you taken your medicine?`);
                            localStorage.setItem(`notified_${reminder.id}`, Date.now().toString());
                        }
                    }
                });
            }

            function showReminderNotification(reminder) {
                // Play alarm sound
                playAlarmSound();
                
                // Browser notification with sound
                if ("Notification" in window && Notification.permission === "granted") {
                    const notification = new Notification("ðŸ’Š Medicine Reminder - ALARM!", {
                        body: `${reminder.name} - ${reminder.dosage}\n${reminder.notes ? 'Note: ' + reminder.notes : ''}`,
                        icon: "ðŸ’Š",
                        badge: "ðŸ’Š",
                        requireInteraction: true,
                        tag: `reminder-${reminder.id}`,
                        vibrate: [200, 100, 200, 100, 200],
                        silent: false
                    });
                    
                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };
                }
                
                // Show in-app alarm modal
                showInAppAlarm(reminder);
                
                // Send WhatsApp reminder if phone available
                sendWhatsAppReminder(reminder);
            }

            // Alarm sound control
            let alarmAudioContext = null;
            let alarmOscillators = [];
            let alarmInterval = null;

            // Alarm sound using Web Audio API
            function playAlarmSound() {
                try {
                    // Stop any existing alarm first
                    stopAlarmSound();
                    
                    alarmAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    function playSequence() {
                        // Create a pleasant alarm sequence
                        const alarmSequence = [
                            { freq: 800, duration: 0.15 },
                            { freq: 900, duration: 0.15 },
                            { freq: 800, duration: 0.15 },
                            { freq: 900, duration: 0.15 },
                            { freq: 1000, duration: 0.3 }
                        ];
                        
                        let startTime = alarmAudioContext.currentTime;
                        
                        alarmSequence.forEach((note) => {
                            const oscillator = alarmAudioContext.createOscillator();
                            const gainNode = alarmAudioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(alarmAudioContext.destination);
                            
                            oscillator.frequency.value = note.freq;
                            oscillator.type = 'sine';
                            
                            gainNode.gain.setValueAtTime(0, startTime);
                            gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                            gainNode.gain.linearRampToValueAtTime(0, startTime + note.duration);
                            
                            oscillator.start(startTime);
                            oscillator.stop(startTime + note.duration);
                            
                            alarmOscillators.push(oscillator);
                            
                            startTime += note.duration + 0.05;
                        });
                    }
                    
                    // Play initial sequence
                    playSequence();
                    
                    // Repeat alarm every 2 seconds
                    let repeatCount = 0;
                    alarmInterval = setInterval(() => {
                        repeatCount++;
                        if (repeatCount < 3) {
                            playSequence();
                        } else {
                            clearInterval(alarmInterval);
                        }
                    }, 2000);
                    
                } catch (error) {
                    console.error('Audio error:', error);
                }
            }

            function stopAlarmSound() {
                // Stop all oscillators
                alarmOscillators.forEach(osc => {
                    try {
                        osc.stop();
                    } catch (e) {
                        // Oscillator might already be stopped
                    }
                });
                alarmOscillators = [];
                
                // Clear interval
                if (alarmInterval) {
                    clearInterval(alarmInterval);
                    alarmInterval = null;
                }
                
                // Close audio context
                if (alarmAudioContext) {
                    try {
                        alarmAudioContext.close();
                    } catch (e) {
                        // Context might already be closed
                    }
                    alarmAudioContext = null;
                }
            }

            function closeAlarmModal() {
                stopAlarmSound();
                const modal = document.getElementById('alarmModal');
                if (modal) {
                    modal.remove();
                }
            }

            // Make functions globally accessible
            window.closeAlarmModal = closeAlarmModal;
            window.stopAlarmSound = stopAlarmSound;

            // In-app alarm modal
            window.showInAppAlarm = function(reminder) {
                // Remove existing alarm if any
                const existingAlarm = document.getElementById('alarmModal');
                if (existingAlarm) {
                    stopAlarmSound();
                    existingAlarm.remove();
                }
                
                const alarmModal = document.createElement('div');
                alarmModal.id = 'alarmModal';
                alarmModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s;">
                        <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: bounceIn 0.5s; position: relative;">
                            <button onclick="window.closeAlarmModal()" style="position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5em; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4); display: flex; align-items: center; justify-content: center; line-height: 1; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                Ã—
                            </button>
                            <div style="font-size: 5em; margin-bottom: 20px; animation: ring 1s infinite;">â°</div>
                            <h2 style="color: #667eea; font-size: 2em; margin-bottom: 15px;">Medicine Reminder!</h2>
                            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #ffc107;">
                                <h3 style="color: #856404; font-size: 1.5em; margin-bottom: 10px;">${reminder.name}</h3>
                                <p style="color: #856404; font-size: 1.2em; margin: 10px 0;"><strong>Dosage:</strong> ${reminder.dosage}</p>
                                <p style="color: #856404; font-size: 1em;"><strong>Time:</strong> ${reminder.time}</p>
                                ${reminder.notes ? `<p style="color: #856404; font-size: 0.95em; margin-top: 10px;"><em>Note: ${reminder.notes}</em></p>` : ''}
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                <button onclick="window.closeAlarmModal()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); flex: 1; min-width: 150px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    âœ… I've Taken It
                                </button>
                                <button onclick="window.snoozeReminder(${reminder.id})" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4); flex: 1; min-width: 150px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    â° Snooze 5 min
                                </button>
                            </div>
                            <div id="whatsappContainer"></div>
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                <button onclick="window.closeAlarmModal()" style="background: transparent; color: #6c757d; border: 2px solid #6c757d; padding: 10px 25px; border-radius: 8px; font-size: 0.95em; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#6c757d'; this.style.color='white'" onmouseout="this.style.background='transparent'; this.style.color='#6c757d'">
                                    âŒ Close Alarm
                                </button>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes bounceIn {
                            0% { transform: scale(0.3); }
                            50% { transform: scale(1.05); }
                            100% { transform: scale(1); }
                        }
                        @keyframes ring {
                            0%, 100% { transform: rotate(0deg); }
                            25% { transform: rotate(-15deg); }
                            75% { transform: rotate(15deg); }
                        }
                    </style>
                `;
                document.body.appendChild(alarmModal);
                
                // Add WhatsApp button
                addWhatsAppButton(reminder);
            }

            window.snoozeReminder = function(reminderId) {
                window.closeAlarmModal();
                
                // Show snooze confirmation
                const msg = document.getElementById('chatMessages');
                if (msg) {
                    const snoozeMsg = document.createElement('div');
                    snoozeMsg.className = 'message bot';
                    snoozeMsg.innerHTML = `
                        <div class="message-avatar">ðŸ¥</div>
                        <div class="message-content">
                            â° <strong>Alarm Snoozed</strong><br>
                            I'll remind you again in 5 minutes.
                        </div>
                    `;
                    msg.appendChild(snoozeMsg);
                    msg.scrollTop = msg.scrollHeight;
                }
                
                // Set alarm to ring again in 5 minutes
                setTimeout(() => {
                    const reminder = reminders.find(r => r.id === reminderId);
                    if (reminder) {
                        window.showInAppAlarm(reminder);
                        playAlarmSound();
                    }
                }, 300000); // 5 minutes = 300,000 milliseconds
            }

            // WhatsApp reminder integration
            function sendWhatsAppReminder(reminder) {
                // This will be handled by the WhatsApp button in the modal
                console.log('WhatsApp reminder ready for:', reminder.name);
            }

            function addWhatsAppButton(reminder) {
                const userPhone = userProfile.phone || '';
                
                // Create WhatsApp message
                const message = `ðŸ¥ *MEDICINE REMINDER* ðŸ¥

â° Time: ${reminder.time}
ðŸ’Š Medicine: ${reminder.name}
ðŸ“‹ Dosage: ${reminder.dosage}
${reminder.notes ? `ðŸ“ Note: ${reminder.notes}` : ''}

âš•ï¸ Please take your medicine now!

--
Sent by HealthCare AI Assistant`;

                const encodedMessage = encodeURIComponent(message);
                
                setTimeout(() => {
                    const container = document.getElementById('whatsappContainer');
                    if (container) {
                        if (userPhone) {
                            const cleanPhone = userPhone.replace(/\D/g, '');
                            const whatsappURL = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
                            container.innerHTML = `
                                <a href="${whatsappURL}" target="_blank" style="display: inline-block; background: #25D366; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-size: 1em; font-weight: bold; cursor: pointer; margin-top: 15px; text-decoration: none; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);">
                                    ðŸ“± Send to My WhatsApp
                                </a>
                            `;
                        } else {
                            container.innerHTML = `
                                <p style="color: #666; font-size: 0.9em; margin-top: 15px;">
                                    ðŸ’¡ Add your phone number in Profile to enable WhatsApp reminders
                                </p>
                            `;
                        }
                    }
                }, 100);
            }

            async function addReminder(reminderData) {
                const newReminder = {
                    id: Date.now(),
                    ...reminderData,
                    active: true
                };
                const updatedReminders = [...reminders, newReminder];
                setReminders(updatedReminders);
                await storage.set('health-reminders', updatedReminders);
                setShowReminderModal(false);
                
                const whatsappNote = userProfile.phone ? '\nðŸ“± You\'ll also get a WhatsApp reminder option!' : '\nðŸ’¡ Tip: Add your phone number in Profile to enable WhatsApp reminders.';
                addBotMessage(`âœ… Perfect! I've set a reminder for **${reminderData.name}** at **${reminderData.time}**.\n\nâ° When it's time, you'll get:\nâ€¢ Alarm sound notification\nâ€¢ Browser notification\nâ€¢ In-app alert modal${whatsappNote}`);
            }

            async function deleteReminder(id) {
                const updatedReminders = reminders.filter(r => r.id !== id);
                setReminders(updatedReminders);
                await storage.set('health-reminders', updatedReminders);
            }

            async function saveProfile(profileData) {
                setUserProfile(profileData);
                await storage.set('health-profile', profileData);
                setShowProfileModal(false);
                addBotMessage(`âœ… Thank you! I've saved your health profile. This helps me provide more personalized advice for you. How can I help you today?`);
            }

            // Request notification permission
            useEffect(() => {
                if ("Notification" in window && Notification.permission === "default") {
                    Notification.requestPermission();
                }
            }, []);

            return (
                <div className="app-container">
                    <Header 
                        onShowProfile={() => setShowProfileModal(true)}
                        onShowReminders={() => {}}
                        isOnline={true}
                    />
                    
                    <div className="main-layout">
                        <Sidebar 
                            reminders={reminders}
                            onAddReminder={() => setShowReminderModal(true)}
                            onDeleteReminder={deleteReminder}
                            userProfile={userProfile}
                        />
                        
                        <ChatArea 
                            messages={messages}
                            inputValue={inputValue}
                            setInputValue={setInputValue}
                            onSend={sendMessage}
                            isTyping={isTyping}
                            onQuickAsk={quickAsk}
                            conversationContext={conversationContext}
                            messagesEndRef={messagesEndRef}
                            chatInputRef={chatInputRef}
                            handleKeyPress={handleKeyPress}
                        />
                    </div>

                    {showReminderModal && (
                        <ReminderModal 
                            onClose={() => setShowReminderModal(false)}
                            onSave={addReminder}
                        />
                    )}

                    {showProfileModal && (
                        <ProfileModal 
                            onClose={() => setShowProfileModal(false)}
                            onSave={saveProfile}
                            currentProfile={userProfile}
                        />
                    )}
                </div>
            );
        }

        // Header Component
        function Header({ onShowProfile, isOnline }) {
            return (
                <div className="header">
                    <h1>ðŸ¥ HealthCare AI Assistant</h1>
                    <div style={{ display: 'flex', gap: '15px', alignItems: 'center' }}>
                        <div className="status-indicator">
                            <div className="status-dot"></div>
                            <span>AI Online</span>
                        </div>
                        <button className="header-btn" onClick={onShowProfile}>
                            ðŸ“Š My Profile
                        </button>
                    </div>
                </div>
            );
        }

        // Sidebar Component
        function Sidebar({ reminders, onAddReminder, onDeleteReminder, userProfile }) {
            return (
                <div className="sidebar">
                    <div className="sidebar-section">
                        <h3>ðŸ’Š Medicine Reminders</h3>
                        {reminders.length === 0 ? (
                            <p style={{ color: '#999', textAlign: 'center', padding: '20px', fontSize: '0.9em' }}>
                                No reminders set yet
                            </p>
                        ) : (
                            reminders.map(reminder => (
                                <div key={reminder.id} className="reminder-card">
                                    <div className="reminder-header">
                                        <span className="reminder-name">{reminder.name}</span>
                                        <span className="reminder-time">{reminder.time}</span>
                                    </div>
                                    <div className="reminder-details">
                                        <div>ðŸ’Š {reminder.dosage}</div>
                                        <div>ðŸ”„ {reminder.frequency}</div>
                                        {reminder.notes && <div>ðŸ“ {reminder.notes}</div>}
                                    </div>
                                    <button 
                                        className="delete-btn" 
                                        onClick={() => onDeleteReminder(reminder.id)}
                                    >
                                        Delete
                                    </button>
                                </div>
                            ))
                        )}
                        <button className="add-reminder-btn" onClick={onAddReminder}>
                            + Add Reminder
                        </button>
                    </div>

                    {userProfile.age && (
                        <div className="sidebar-section">
                            <h3>ðŸ‘¤ Your Profile</h3>
                            <div className="health-stats">
                                <div className="stat-item">
                                    <span className="stat-label">Age</span>
                                    <span className="stat-value">{userProfile.age} years</span>
                                </div>
                                {userProfile.gender && (
                                    <div className="stat-item">
                                        <span className="stat-label">Gender</span>
                                        <span className="stat-value">{userProfile.gender}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="sidebar-section">
                        <h3>ðŸ’¡ Health Tip</h3>
                        <div className="health-tip-card">
                            <h4>Stay Hydrated!</h4>
                            <p>Drink at least 8 glasses of water daily. Proper hydration supports all bodily functions and helps maintain energy levels.</p>
                        </div>
                    </div>
                </div>
            );
        }

        // Chat Area Component
        function ChatArea({ messages, inputValue, setInputValue, onSend, isTyping, onQuickAsk, conversationContext, messagesEndRef, chatInputRef, handleKeyPress }) {
            return (
                <div className="chat-container">
                    {conversationContext.symptoms.length > 0 && (
                        <div className="context-banner">
                            <span>ðŸ”</span>
                            <div>
                                <strong>Active symptoms:</strong> {conversationContext.symptoms.map(s => (
                                    <span key={s} className="symptom-badge">{s}</span>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="chat-messages">
                        {messages.map((msg, idx) => (
                            <Message key={idx} message={msg} />
                        ))}
                        {isTyping && <TypingIndicator />}
                        <div ref={messagesEndRef} />
                    </div>

                    <div className="quick-actions">
                        <button className="quick-btn" onClick={() => { setInputValue("I'm feeling feverish, what should I do?"); setTimeout(() => sendMessage(), 100); }}>
                            ðŸ¤’ Fever Help
                        </button>
                        <button className="quick-btn" onClick={() => { setInputValue("Create a diabetes-friendly diet plan for me"); setTimeout(() => sendMessage(), 100); }}>
                            ðŸŽ Diabetes Diet
                        </button>
                        <button className="quick-btn" onClick={() => { setInputValue("What exercises are safe for elderly people?"); setTimeout(() => sendMessage(), 100); }}>
                            ðŸ§“ Senior Exercise
                        </button>
                        <button className="quick-btn" onClick={() => { setInputValue("How can I improve my sleep quality?"); setTimeout(() => sendMessage(), 100); }}>
                            ðŸ˜´ Better Sleep
                        </button>
                        <button className="quick-btn" onClick={() => { setInputValue("Give me tips for managing stress"); setTimeout(() => sendMessage(), 100); }}>
                            ðŸ§˜ Stress Management
                        </button>
                    </div>

                    <div className="chat-input-area">
                        <div className="input-wrapper">
                            <textarea
                                ref={chatInputRef}
                                className="chat-input"
                                value={inputValue}
                                onChange={(e) => setInputValue(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Describe your symptoms or ask me anything about your health..."
                                rows="1"
                            />
                            <button 
                                className="send-btn" 
                                onClick={onSend}
                                disabled={!inputValue.trim() || isTyping}
                            >
                                {isTyping ? 'Thinking...' : 'Send'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Message Component
        function Message({ message }) {
            const formatText = (text) => {
                return text
                    .split('\n')
                    .map((line, i) => (
                        <React.Fragment key={i}>
                            {line.split('**').map((part, j) => 
                                j % 2 === 0 ? part : <strong key={j}>{part}</strong>
                            )}
                            <br />
                        </React.Fragment>
                    ));
            };

            return (
                <div className={`message ${message.type}`}>
                    <div className="message-avatar">
                        {message.type === 'bot' ? 'ðŸ¥' : 'ðŸ‘¤'}
                    </div>
                    <div className="message-content">
                        {formatText(message.text)}
                    </div>
                </div>
            );
        }

        // Typing Indicator Component
        function TypingIndicator() {
            return (
                <div className="message bot">
                    <div className="message-avatar">ðŸ¥</div>
                    <div className="typing-indicator">
                        <div className="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            );
        }

        // Reminder Modal Component
        function ReminderModal({ onClose, onSave }) {
            const [formData, setFormData] = useState({
                name: '',
                dosage: '',
                time: '',
                frequency: 'daily',
                notes: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name || !formData.dosage || !formData.time) {
                    alert('Please fill in all required fields');
                    return;
                }
                onSave(formData);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <h2>ðŸ’Š Add Medicine Reminder</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Medicine Name *</label>
                                <input 
                                    type="text" 
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="e.g., Aspirin, Metformin"
                                />
                            </div>
                            <div className="form-group">
                                <label>Dosage *</label>
                                <input 
                                    type="text" 
                                    value={formData.dosage}
                                    onChange={(e) => setFormData({...formData, dosage: e.target.value})}
                                    placeholder="e.g., 1 tablet, 5ml"
                                />
                            </div>
                            <div className="form-group">
                                <label>Time *</label>
                                <input 
                                    type="time" 
                                    value={formData.time}
                                    onChange={(e) => setFormData({...formData, time: e.target.value})}
                                />
                            </div>
                            <div className="form-group">
                                <label>Frequency</label>
                                <select 
                                    value={formData.frequency}
                                    onChange={(e) => setFormData({...formData, frequency: e.target.value})}
                                >
                                    <option value="daily">Daily</option>
                                    <option value="twice">Twice a day</option>
                                    <option value="thrice">Three times a day</option>
                                    <option value="weekly">Weekly</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label>Notes (optional)</label>
                                <textarea 
                                    rows="3"
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    placeholder="e.g., Take with food, Before bedtime"
                                />
                            </div>
                            <button type="submit" className="btn-primary">Add Reminder</button>
                            <button type="button" className="btn-secondary" onClick={onClose}>Cancel</button>
                        </form>
                    </div>
                </div>
            );
        }

        // Profile Modal Component
        function ProfileModal({ onClose, onSave, currentProfile }) {
            const [formData, setFormData] = useState(currentProfile || {
                name: '',
                email: '',
                phone: '',
                age: '',
                gender: '',
                conditions: '',
                allergies: ''
            });
            const [isSaving, setIsSaving] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // Validate required fields
                if (!formData.name || !formData.email || !formData.phone) {
                    alert('Please fill in Name, Email, and Phone Number - these are required fields.');
                    return;
                }

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(formData.email)) {
                    alert('Please enter a valid email address.');
                    return;
                }

                // Validate phone format (basic validation)
                const phoneRegex = /^[0-9]{10,15}$/;
                if (!phoneRegex.test(formData.phone.replace(/[\s-()]/g, ''))) {
                    alert('Please enter a valid phone number (10-15 digits).');
                    return;
                }

                setIsSaving(true);
                
                // Send lead information to email
                await sendLeadToEmail(formData);
                
                // Save to local storage
                onSave(formData);
                setIsSaving(false);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <h2>ðŸ“Š Complete Your Health Profile</h2>
                        <div className="alert alert-info">
                            Your information helps us provide personalized health advice and allows our healthcare team to contact you if needed.
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Full Name *</label>
                                <input 
                                    type="text" 
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="Enter your full name"
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Email Address *</label>
                                <input 
                                    type="email" 
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    placeholder="your.email@example.com"
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Phone Number *</label>
                                <input 
                                    type="tel" 
                                    value={formData.phone}
                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                    placeholder="10-digit phone number"
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Age</label>
                                <input 
                                    type="number" 
                                    value={formData.age}
                                    onChange={(e) => setFormData({...formData, age: e.target.value})}
                                    placeholder="Enter your age"
                                />
                            </div>
                            <div className="form-group">
                                <label>Gender</label>
                                <select 
                                    value={formData.gender}
                                    onChange={(e) => setFormData({...formData, gender: e.target.value})}
                                >
                                    <option value="">Select</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label>Existing Health Conditions</label>
                                <textarea 
                                    rows="3"
                                    value={formData.conditions}
                                    onChange={(e) => setFormData({...formData, conditions: e.target.value})}
                                    placeholder="e.g., Diabetes, High blood pressure, Arthritis"
                                />
                            </div>
                            <div className="form-group">
                                <label>Allergies</label>
                                <textarea 
                                    rows="2"
                                    value={formData.allergies}
                                    onChange={(e) => setFormData({...formData, allergies: e.target.value})}
                                    placeholder="e.g., Penicillin, Peanuts, Shellfish"
                                />
                            </div>
                            <div className="alert alert-warning">
                                <small>* Required fields. By submitting, you consent to be contacted by our healthcare team for personalized assistance.</small>
                            </div>
                            <button type="submit" className="btn-primary" disabled={isSaving}>
                                {isSaving ? 'Saving...' : 'Save Profile'}
                            </button>
                            <button type="button" className="btn-secondary" onClick={onClose}>Cancel</button>
                        </form>
                    </div>
                </div>
            );
        }

        // Function to send lead information via email
        async function sendLeadToEmail(profileData) {
            try {
                const emailBody = `
New Health Chatbot Lead Submission
===================================

CONTACT INFORMATION:
-------------------
Name: ${profileData.name}
Email: ${profileData.email}
Phone: ${profileData.phone}

HEALTH PROFILE:
--------------
Age: ${profileData.age || 'Not provided'}
Gender: ${profileData.gender || 'Not provided'}

Existing Health Conditions:
${profileData.conditions || 'None specified'}

Allergies:
${profileData.allergies || 'None specified'}

SUBMISSION DETAILS:
------------------
Date: ${new Date().toLocaleString()}
Source: HealthCare AI Assistant Chatbot

---
This lead was automatically captured from the HealthCare AI Assistant platform.
Please follow up with the patient at the provided contact information.
                `.trim();

                // Using Web3Forms API (free email service)
                const response = await fetch('https://api.web3forms.com/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        access_key: '5e99e6e5-1b48-49a8-a151-7cd1650a7d04',
                        subject: `New Health Lead: ${profileData.name}`,
                        from_name: 'HealthCare AI Assistant',
                        to_email: 'gaurmayank1978@gmail.com',
                        message: emailBody,
                        // Additional fields for better tracking
                        name: profileData.name,
                        email: profileData.email,
                        phone: profileData.phone,
                        age: profileData.age,
                        gender: profileData.gender,
                        conditions: profileData.conditions,
                        allergies: profileData.allergies
                    })
                });

                const result = await response.json();
                
                if (!result.success) {
                    console.error('Failed to send email:', result);
                    // Still save locally even if email fails
                }
            } catch (error) {
                console.error('Error sending lead email:', error);
                // Don't block the profile save if email fails
            }
        }

        // Render the app
        ReactDOM.render(<HealthCareApp />, document.getElementById('root'));
    </script>
</body>
</html>
